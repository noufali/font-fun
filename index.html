<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<!-- <link rel="stylesheet" type="text/css" href="css/style.css"> -->
	<title>Font Fun</title>
	<style>
			* {
					box-sizing: border-box;
			}
			html,
			body {
					width: 100%;
					height: 100%;
					overflow: hidden;
			}
			#preview, #snap {
				background-color: #30429A;
			}
	</style>
</head>

<body>
	<canvas id="preview" width="940" height="300" class="text"></canvas>
	    <div id="message"></div>
	    <label>Font Size<input type="range" min="6" max="500" step="2" value="150" id="font-size-range" autocomplete="off"><span id="fontSize">150</span></label>
	    <label><input type="checkbox" onchange="drawPointsChanged(this)" checked="checked">Draw Points</label>
	    <label><input type="checkbox" onchange="drawMetricsChanged(this)">Draw Metrics</label>
	    <label><input type="checkbox" onchange="kerningChanged(this)" checked="checked">Kerning</label>
	    <label><input type="checkbox" onchange="ligaturesChanged(this)" checked="checked">Ligatures</label>

	    <hr>

	 <canvas id="snap" width="940" height="300" class="text"></canvas>
	    <label>Strength <input type="range" min="-15" max="100" value="80" oninput="snapStrengthChanged(this)"/><span id="snapStrength">80</span></label>
	    <label>Distance<input type="range" min="1" max="100" value="53" oninput="snapDistanceChanged(this)"/><span id="snapDistance">53</span></label>
	    <label>X<input type="range" min="-100" max="100" value="0" oninput="snapXChanged(this)"/><span id="snapX">0</span></label>
	    <label>Y<input type="range" min="-100" max="100" value="0" oninput="snapYChanged(this)"/><span id="snapY">0</span></label>

	    <hr>

</body>
<script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>

<script type="text/javascript">
var font = null;
var fontSize = 150;
var textToRender = "slm";
var drawPoints = true;
var drawMetrics = false;
var kerning = true;
var ligatures = true;
var hinting = false;
var previewPath = null;
var snapPath = null;
var snapStrength = 80;
var snapDistance = 53;
var snapX = 0;
var snapY = 0;
var fontSizeSlider = document.getElementById("font-size-range");

function drawPointsChanged(e) {
    drawPoints = e.checked;
    renderText();
}

function drawMetricsChanged(e) {
    drawMetrics = e.checked;
    renderText();
}

function kerningChanged(e) {
    kerning = e.checked;
    renderText();
}

function ligaturesChanged(e) {
    ligatures = e.checked;
    renderText();
}

function fontSizeChanged() {
    fontSize = parseInt(fontSizeSlider.value, 10);
    document.getElementById('fontSize').innerHTML = '' + fontSize;
    renderText();
}

function snapStrengthChanged(e) {
    snapStrength = e.value;
    document.getElementById('snapStrength').innerHTML = '' + snapStrength;
    renderText();
}

function snapDistanceChanged(e) {
    snapDistance = e.value;
    document.getElementById('snapDistance').innerHTML = '' + snapDistance;
    renderText();
}

function snapXChanged(e) {
    snapX = e.value * 1.0;
    document.getElementById('snapX').innerHTML = '' + snapX;
    renderText();
}

function snapYChanged(e) {
    snapY = e.value * 1.0;
    document.getElementById('snapY').innerHTML = '' + snapY;
    renderText();
}

// Round a value to the nearest "step".
function snap(v, distance, strength) {
    return (v * (1.0 - strength)) + (strength * Math.round(v / distance) * distance);
}

function doSnap(path) {
    var i;
    var strength = snapStrength / 100.0;
    for (i = 0; i < path.commands.length; i++) {
        var cmd = path.commands[i];
        if (cmd.type !== 'Z') {
            cmd.x = snap(cmd.x + snapX, snapDistance, strength) - snapX;
            cmd.y = snap(cmd.y + snapY, snapDistance, strength) - snapY;
        }
        if (cmd.type === 'Q' || cmd.type === 'C') {
            cmd.x1 = snap(cmd.x1 + snapX, snapDistance, strength) - snapX;
            cmd.y1 = snap(cmd.y1 + snapY, snapDistance, strength) - snapY;
        }
        if (cmd.type === 'C') {
            cmd.x2 = snap(cmd.x2 + snapX, snapDistance, strength) - snapX;
            cmd.y2 = snap(cmd.y2 + snapY, snapDistance, strength) - snapY;
        }
    }
}

opentype.load('fonts/BlockSquare-H050-V050.otf', function(err, font) {
    if (err) {
        alert('Could not load font: ' + err);
    } else {
				console.log("successful loading of font");
				console.log(font);
				onFontLoaded(font);
        // Use your font here.
    }
});

function onFontLoaded(font) {
    var glyphsDiv, i, x, y, fontSize;
    window.font = font;

    // Show the first 100 glyphs.
    // glyphsDiv = document.getElementById('glyphs');
    // glyphsDiv.innerHTML = '';

    amount = Math.min(100, font.glyphs.length);
    x = 50;
    y = 120;
    fontSize = 200;
    // for (i = 0; i < amount; i++) {
    //     glyph = font.glyphs.get(i);
    //     ctx = createGlyphCanvas(glyph, 150);
    //     glyph.draw(ctx, x, y, fontSize);
    //     glyph.drawPoints(ctx, x, y, fontSize);
    //     glyph.drawMetrics(ctx, x, y, fontSize);
    // }

    renderText();
}

function renderText() {
    if (!font) return;
    //textToRender = document.getElementById('textField').value;
    var previewCtx = document.getElementById('preview').getContext('2d');
    var options = {
        kerning: kerning,
        hinting: hinting,
        features: {
            liga: ligatures,
            rlig: ligatures
        }
    };
		// drawing font
    previewCtx.clearRect(0, 0, 940, 300);
    //font.draw(previewCtx, textToRender, 0, 200, fontSize, options);
		fontPath = font.getPath(textToRender, 300, 200, fontSize, options);
		fontPath.fill = "#EB5D4A";
		fontPath.draw(previewCtx);

		// if you want to see font points
    if (drawPoints) {
        font.drawPoints(previewCtx, textToRender, 300, 200, fontSize, options);
    }

		// if you want to see font glyphs
    if (drawMetrics) {
        font.drawMetrics(previewCtx, textToRender, 300, 200, fontSize, options);
    }

    snapPath = font.getPath(textToRender, 300, 200, fontSize, options);
		snapPath.fill = "#EB5D4A";
    doSnap(snapPath);
    var snapCtx = document.getElementById('snap').getContext('2d');
    snapCtx.clearRect(0, 0, 940, 300);
    snapPath.draw(snapCtx);

		// if (drawPoints) {
		// 		font.drawPoints(snapCtx, textToRender, 300, 200, fontSize, options);
		// }

		if (drawMetrics) {
				font.drawMetrics(snapCtx, textToRender, 300, 200, fontSize, options);
		}
}
fontSizeSlider.addEventListener('input', fontSizeChanged, false);
fontSizeSlider.addEventListener('change', fontSizeChanged, false);
animate();

function animate(){
	//console.log("again");
	requestAnimationFrame(animate);
}

</script>

</html>
